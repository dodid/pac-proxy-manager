{% extends "base.html" %}

{% block content %}
<style>
    .action-btn {
        min-width: 90px;
        padding: 0.375rem 0.75rem;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        transition: all 0.2s ease;
        font-size: 0.875rem;
        color: #212529;
        background-color: white;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .action-btn i {
        margin-right: 0.5rem;
    }
    .action-btn:hover {
        background-color: #f8f9fa;
        transform: translateY(-1px);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }
    .delete-btn {
        background-color: #dc3545;
        color: white;
        border-color: #dc3545;
    }
    .delete-btn:hover {
        background-color: #c82333;
        border-color: #bd2130;
    }
    .table thead th {
        font-weight: 500;
        background-color: #f8f9fa;
        vertical-align: middle;
    }
    .table tbody td {
        vertical-align: middle;
    }
    .table tbody tr {
        transition: background-color 0.2s ease;
    }
    .table tbody tr:hover {
        background-color: #f8f9fa;
    }
    .status-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 500;
        display: inline-block;
    }
    .status-active {
        background-color: #e8f5e9;
        color: #2e7d32;
    }
    .status-inactive {
        background-color: #ffebee;
        color: #c62828;
    }
    .proxy-url {
        font-family: monospace;
        font-size: 0.875rem;
        color: #6c757d;
    }
    .route-count {
        font-size: 0.875rem;
        color: #6c757d;
        text-align: center;
    }
    .route-count span {
        font-weight: 500;
        color: #212529;
    }
    .dropdown-toggle::after {
        display: none;
    }
    .dropdown:hover .dropdown-menu {
        display: block;
        margin-top: 0; /* remove the gap */
    }
    .dropdown-menu {
        min-width: 150px;
        border: 1px solid rgba(0, 0, 0, 0.15);
        border-radius: 0.375rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        display: none; /* hide by default */
    }
    .dropdown-item {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
    }
    .dropdown-item i {
        width: 1rem;
        margin-right: 0.5rem;
    }
    .dropdown-item:hover {
        background-color: #f8f9fa;
    }
    .dropdown-item.text-danger:hover {
        background-color: #fff5f5;
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">PAC Files</h1>
    <a href="/create" class="btn btn-primary">
        <i class="fas fa-plus me-2"></i>Create New
    </a>
</div>

<div class="card border-0 shadow-sm">
    <div class="card-body p-0">
        <table class="table table-hover mb-0">
            <thead>
                <tr>
                    <th class="ps-4">Name</th>
                    <th>Proxy URL</th>
                    <th class="text-center">Proxied</th>
                    <th class="text-center">Bypassed</th>
                    <th class="pe-4">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for pac in pac_files %}
                <tr>
                    <td class="ps-4 align-middle">{{ pac.name }}</td>
                    <td class="align-middle proxy-url">{{ pac.proxy_url }}</td>
                    <td class="align-middle route-count">
                        <span>{{ pac.editor_content.proxied_domains.split('\n') | length + pac.editor_content.proxied_ips.split('\n') | length }}</span>
                    </td>
                    <td class="align-middle route-count">
                        <span>{{ pac.editor_content.bypassed_ips.split('\n') | length }}</span>
                    </td>
                    <td class="pe-4 align-middle">
                        <div class="d-flex gap-2">
                            <a href="/edit/{{ pac.id }}" class="btn action-btn">
                                <i class="fas fa-edit"></i>Edit
                            </a>
                            <button class="btn action-btn copy-url-btn" data-url="/{{ pac.name }}/proxy.pac">
                                <i class="fas fa-copy"></i>Copy
                            </button>
                            <button class="btn action-btn test-url-btn" data-name="{{ pac.name }}">
                                <i class="fas fa-vial"></i>Test URL
                            </button>
                            <div class="dropdown">
                                <button class="btn action-btn dropdown-toggle" type="button" id="dropdownMenuButton{{ pac.id }}" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton{{ pac.id }}">
                                    <li>
                                        <a class="dropdown-item" href="/log/{{ pac.id }}">
                                            <i class="fas fa-list me-2"></i>View Log
                                        </a>
                                    </li>
                                    <li>
                                        <button class="dropdown-item text-danger delete-btn" data-id="{{ pac.id }}" data-name="{{ pac.name }}">
                                            <i class="fas fa-trash me-2"></i>Delete
                                        </button>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Remove click event listeners for dropdowns since we're using hover
    const dropdownToggles = document.querySelectorAll('.dropdown-toggle');
    dropdownToggles.forEach(toggle => {
        toggle.removeAttribute('data-bs-toggle');
    });

    // Add slight delay for better user experience
    let hoverTimeout;
    const dropdowns = document.querySelectorAll('.dropdown');

    dropdowns.forEach(dropdown => {
        dropdown.addEventListener('mouseenter', function() {
            clearTimeout(hoverTimeout);
            this.querySelector('.dropdown-menu').style.display = 'block';
        });

        dropdown.addEventListener('mouseleave', function() {
            const menu = this.querySelector('.dropdown-menu');
            hoverTimeout = setTimeout(() => {
                menu.style.display = 'none';
            }, 200); // 200ms delay before hiding
        });
    });

    // Add click handlers to all copy URL buttons
    document.querySelectorAll('.copy-url-btn').forEach(button => {
        button.addEventListener('click', function() {
            const url = this.getAttribute('data-url');
            navigator.clipboard.writeText(window.location.origin + url)
                .then(() => {
                    // Show temporary success message
                    const originalText = this.textContent;
                    this.textContent = 'Copied!';
                    this.classList.remove('action-btn');
                    this.classList.add('btn-success');

                    // Revert after 2 seconds
                    setTimeout(() => {
                        this.textContent = originalText;
                        this.classList.remove('btn-success');
                        this.classList.add('action-btn');
                    }, 2000);
                })
                .catch(err => {
                    alert('Failed to copy URL: ' + err);
                });
        });
    });

    // Update delete button handler to work with dropdown items
    document.querySelectorAll('.delete-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const pacId = this.getAttribute('data-id');
            const pacName = this.getAttribute('data-name');

            if (confirm(`Are you sure you want to delete "${pacName}"?`)) {
                fetch(`/delete/${pacId}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        alert('Failed to delete PAC file');
                    }
                })
                .catch(err => {
                    alert('Error deleting PAC file: ' + err);
                });
            }
        });
    });

    // Update test URL button handler
    document.querySelectorAll('.test-url-btn').forEach(button => {
        button.addEventListener('click', async function() {
            const pacName = this.getAttribute('data-name');
            const testUrl = prompt('Enter URL to test (e.g., https://example.com):');

            if (testUrl) {
                try {
                    // Show loading state
                    this.disabled = true;
                    this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Testing...';

                    // Test URL
                    const response = await fetch(`/test/${pacName}?url=${encodeURIComponent(testUrl)}`);

                    if (!response.ok) {
                        // Handle API errors
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Failed to test URL');
                    }

                    const data = await response.json();

                    // Show result with tested URL and matching rule
                    const result = data.result === 'PROXY' ? 'PROXIED' : 'DIRECT';
                    const rule = data.matched_rule ? `\nRule: ${data.matched_rule}` : '';
                    alert(`${testUrl}: ${result}${rule}`);

                } catch (error) {
                    // Show error with tested URL
                    alert(`Error testing ${testUrl}: ${error.message}`);
                    console.error('Error testing URL:', error);
                } finally {
                    // Restore button state
                    this.innerHTML = '<i class="fas fa-vial me-2"></i>Test URL';
                    this.disabled = false;
                }
            }
        });
    });
});
</script>

<!-- Add Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Add Font Awesome for icons -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">

<!-- Add Popper.js and Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"></script>
{% endblock %}